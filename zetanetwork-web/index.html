<!-- index.html (servi depuis zetanetwork.org) -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Zeta Network</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        #feed { border: 1px solid #ccc; padding: 1rem; height: 400px; overflow-y: auto; margin: 1rem 0; }
        #status { color: #666; margin: 0.5rem 0; }
    </style>
</head>
<body>
    <h1>Zeta Network</h1>
    <div id="status">Connexion...</div>
    <div id="nodes">Nœuds: 0</div>
    <input id="msg" placeholder="Message" style="width:70%">
    <button onclick="send()">Envoyer</button>
    <div id="feed"></div>

    <script type="module">
        // Import js-libp2p (léger, uniquement pour WebSocket)
        import { createLibp2p } from 'https://cdn.jsdelivr.net/npm/libp2p@0.46/+esm';
        import { gossipsub } from 'https://cdn.jsdelivr.net/npm/@libp2p/gossipsub/+esm';
        import { webSockets } from 'https://cdn.jsdelivr.net/npm/libp2p/websockets/+esm';
        import { mplex } from 'https://cdn.jsdelivr.net/npm/libp2p/mplex/+esm';
        import { noise } from 'https://cdn.jsdelivr.net/npm/libp2p/noise/+esm';

        let libp2p;

        async function init() {
            // Se connecter via WebSocket aux VPS
            const bootstrap = [
                '/dns4/zetanetwork.org/tcp/9091/ws/p2p/QmVPS1',
                '/dns4/zetanetwork.org/tcp/9091/ws/p2p/QmVPS2'
            ];

            libp2p = await createLibp2p({
                transports: [webSockets()],
                streamMuxers: [mplex()],
                connectionEncryption: [noise()],
                pubsub: gossipsub(),
                peerDiscovery: []
            });

            await libp2p.start();

            // Mesurer latence et garder les 10 meilleurs
            const nodes = await Promise.all(
                bootstrap.map(async addr => {
                    const start = Date.now();
                    try {
                        await libp2p.dial(addr);
                        return { addr, latency: Date.now() - start };
                    } catch {
                        return { addr, latency: Infinity };
                    }
                })
            );

            const best = nodes
                .filter(n => n.latency < 10000)
                .sort((a, b) => a.latency - b.latency)
                .slice(0, 10);

            document.getElementById('nodes').textContent = `Nœuds: ${best.length}`;

            // S'abonner au topic
            await libp2p.pubsub.subscribe('global-feed');
            libp2p.pubsub.addEventListener('message', (evt) => {
                if (evt.detail.topic === 'global-feed') {
                    const msg = new TextDecoder().decode(evt.detail.data);
                    document.getElementById('feed').innerHTML += `<div>${msg}</div>`;
                }
            });

            document.getElementById('status').textContent = '✅ Connecté';
        }

        function send() {
            const msg = document.getElementById('msg').value;
            if (msg && libp2p) {
                libp2p.pubsub.publish('global-feed', new TextEncoder().encode(msg));
                document.getElementById('msg').value = '';
            }
        }

        init();
    </script>
</body>
</html>